# Extract the sequences from the adapters' files'
for i in /usr/local/src/trimmomatic-0.32/adapters/*
do
	grep -v ^">" $i > ${i##*/}.adapters
done

cat /dev/null > results.csv

# Write as first column of the result file the name of the
# original fasta file
for i in *.adapters                      # For each adapter file
do
    nlines=$(wc -l $i | cut -f 1 -d " ") # Compute the number of seqs/file
    for j in $(seq 1 $nlines)            # Print n times the file name 
    do
        echo ${i%.adapters}              # Throw away extension
    done
done > results.csv                       # Write the echos to file

# Clean folder
cat *.adapters > sequences.txt # Cat all sequences for the parallel loop
rm *.adapters                  # Clean

# Append the second column of the results file (the sequences)
paste results.csv sequences.txt > tmp.txt
mv tmp.txt results.csv

# Perform the search:
# Keep order, count and append. One file per sample, multiple sequences
parallel \
	-k zgrep -c {1} {2} \>\> {2.}.tmp \
	::: $(cat sequences.txt)          \
	::: *.fastq.gz


# Put together all results

for i in *.tmp
do
	cut -f 1 $i > tmp.column               # Take the first (and only) field 
	paste results.csv tmp.column > tmp.csv # Append column
	mv tmp.csv results.csv                 # Switch tmp and result file
	rm tmp.column $i
done

# Add header to results.csv
header='Adapter\tSequence\t' # First two columns

for i in *.fastq.gz
do
	header=$(echo -e $header'\t'${i%.fastq.gz}) # Append file name w/o .fasta
done
echo -e $header > tmp.file                      # Add to beginning of file
cat tmp.file results.csv > tmp2                 # Cat the original results.csv
mv tmp2 adaptorResults.csv                             # Rename
rm tmp.file sequences
